<html style="overflow: hidden">
	<head>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Gaegu&display=swap" rel="stylesheet">
		<style type="text/css">
			.container {
				z-index: 10;
				width: 100%;
				height: 100%;

				background-color: rgba(255, 255, 255, 0);
			}

			.noteWrapper {
				width: min(90vw, 400px);
				height: 85%;
				
				margin: 0 auto;
				padding: 4px 4px 4px 32px;
				
				background-image: url("https://github.com/rlaghdcjf12/ZEP/blob/main/seekHANSout/floor5/assets/hansNote.png?raw=true");
				background-size: cover;
			}

			.flex {
				display: flex;
			}

			.closeButton {
				margin-left: auto;

				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
				user-select:none
			}

			.closeButton img {
				width: 24px;
				height: 24px;
			}

			p {
				margin: 4px 0;
				
				font-family: "Gaegu";
				font-size: 24px;
				color: black;
			}

			.Box {
				width: 100%;
				display: flex;
				margin-top: 4px;
			}

			#options {
				width: 100%;
			}

			.optionGuide {
				width: 10%;
				height: 32px;

				line-height: 32px;
				font-weight: 600;
				text-align: center;
			}

			.option {
				width: 100%;
				height: 32px;
				margin-bottom: 4px;

				border: solid 1px #ccc;
				border-radius: 4px;
				background-color: #f3f2ff;

				line-height: 32px;
				font-size: min(14px, 3vmax);
				color: black;
				text-align: center;
				overflow: hidden;
			}

			.option.selected {
				background-color: #e9e8ff;
				color: #6758ff;
			}

			#button {
				width: 72px;
				height: 32px;
				margin-left: auto;

				border: solid 1px white;
				border-radius: 4px;
				background-color: #6758ff;

				line-height: 32px;
				color: white;
				text-align: center;
			}

			.disable {
				background-color: gray !important;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="noteWrapper">
				<header class="flex">
					<div onclick="javascript:handleCloseButton()" class="closeButton"><img src="https://zep.us/images/svg/close__icon.svg" /></div>
				</header>
				<div class="dialogWrapper">
					<div id="dialog" class="dialog"></div>
				</div>
				<div id="optionBox" class="Box none">
				</div>
				<div id="buttonBox" class="Box">
				</div>
			</div>
		</div>
		<script type="text/javascript">
			let dialogFlow, target;
			let condition = null;
			let selectedOptionNo = -1;
			let selectedLink = -11;
			let selectedCheckListNo = -1;

			window.addEventListener("message", (e) => {
				condition =  e.data.condition;
				dialogFlow = NPC_DIALOG_FLOW[0];

				setTimeout(async () => {
					for (var i = 0; i < dialogFlow.textList.length; i++) {
						document.getElementById("dialog").innerHTML += `<p id='text${i}'></p>`;
						const text = dialogFlow.textList[i];
						await typing(i, text);
						await wait(300);
					}
					
					document.getElementById("optionBox").innerHTML += `
						<div class="optionGuide">>></div>
						<div id="options"></div>`;
					document.getElementById("buttonBox").innerHTML += `
						<div id="button" class="disable" onclick="javascript:handleButton()">확인</div>`;

					if(dialogFlow.options){
						document.getElementById("optionBox").classList.remove('none');
						setOptions(0);
					}
				}, 1000);
			});

			const setOptions = (flowNo) => {
				let Options = document.getElementById("options");
				Options.innerHTML = '';

				dialogFlow.options.forEach(oi => {
					const listNo = oi.link == -3 ? oi.listNo : -1;

					if(oi.condition){
						if(condition.includes(oi.condition)) {
							Options.innerHTML += 
								`<button 
									id="option${oi.number}"
									class="option" 
									onclick="javascript:handleSelectOption(${oi.number}, ${oi.link}, ${listNo})"
								>
									${oi.conditionText}
								</button>`;
						} else {
							Options.innerHTML += 
								`<button class="option disable">${oi.text}</button>`;
						}
					} else {
						Options.innerHTML += 
							`<button
								id="option${oi.number}"
								class="option"
								onclick="javascript:handleSelectOption(${oi.number}, ${oi.link}, ${listNo})"
							>
								${oi.text}
							</button>`;
					}
				});
			}

			const handleCloseButton = () => {
				window.parent.postMessage({type: "closeDialog"}, "*");
			}

			const handleSelectOption = (optNo, link, listNo = -1) => {
				if(selectedOptionNo != -1){
					document.getElementById(`option${selectedOptionNo}`).classList.remove("selected");
				}
				
				selectedOptionNo = optNo;
				selectedLink = link;
				selectedCheckListNo = listNo;
				document.getElementById(`option${optNo}`).classList.add("selected");
				document.getElementById("button").classList.remove("disable");
			}

			const handleButton = () => {
				if (selectedLink == -1){
					handleCloseButton();
				} else if(selectedLink == -3) {
					window.parent.postMessage({type: "setCheckList", listNo: selectedCheckListNo}, "*");
					handleCloseButton();
				} else {
					document.getElementById("text").innerText = dialogFlow[selectedLink].text;
					
					if (dialogFlow[selectedLink].options) {
						setOptions(selectedLink);
					} else {
						document.getElementById("optionBox").classList.add('none');
					}
				}
				
				selectedOptionNo = -1;
				selectedLink = -11;
				selectedCheckListNo = -1;
				document.getElementById("button").classList.add("disable");
			}

			const typing = async (i, text) => {
				const target = document.getElementById(`text${i}`);
				const splitText = text.split('');

				while (splitText.length) {
					await wait(100);
					const c = splitText.shift();
					if (c == ' ') target.innerHTML += '&nbsp;'
					else target.innerText += c;
				}
			}

			const wait = (ms) => {
				return new Promise(res => setTimeout(res, ms));
			}

			const NPC_DIALOG_FLOW = {
				0: {
					textList: [
						"안녕하세요!", 
						"글자가 보이시나요?!",
						"한스입니다!!",
						"이 책을 열어보시는 분이 계시다니...",
						"하늘에 감사합니다!!"],
					options: [
						{
							number: 0,
							text: "네~ 안녕하세요!",
							link: -1,
						},
					],
				},
			};
		</script>
	</body>
</html>
