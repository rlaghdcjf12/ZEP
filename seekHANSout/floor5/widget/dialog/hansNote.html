<html style="overflow: hidden">
	<head>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Gaegu&display=swap" rel="stylesheet">
		<style type="text/css">
			.container {
				z-index: 10;
				width: 100%;
				height: 100%;

				background-color: rgba(255, 255, 255, 0);
			}

			.noteWrapper {
				width: min(90vw, 400px);
				height: 85%;
				
				margin: 0 auto;
				padding: 4px 4px 4px 32px;
				
				background-image: url("https://github.com/rlaghdcjf12/ZEP/blob/main/seekHANSout/floor5/assets/hansNote.png?raw=true");
				background-size: cover;
			}

			.flex {
				display: flex;
			}

			.closeButton {
				margin-left: auto;

				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
				user-select:none
			}

			.closeButton img {
				width: 24px;
				height: 24px;
			}

			p {
				margin: 4px 0;
				
				font-family: "Gaegu";
				font-size: 24px;
				color: black;
			}

			.box {
				width: 100%;
				margin-top: 4px;
			}

			.flex {
				display: flex;
			}

			.onRight {
				margin-left: auto;
			}

			#options {
				width: 100%;
			}

			.optionGuide {
				width: 10%;
				height: 32px;

				line-height: 32px;
				font-weight: 600;
				text-align: center;
			}

			.option {
				width: 100%;
				height: 32px;
				margin-bottom: 4px;

				border: solid 1px #ccc;
				border-radius: 4px;
				background-color: #f3f2ff;

				line-height: 32px;
				font-size: min(14px, 3vmax);
				color: black;
				text-align: center;
				overflow: hidden;
			}

			.option.selected {
				background-color: #e9e8ff;
				color: #6758ff;
			}

			.button {
				width: 72px;
				height: 32px;
				margin-left: auto;

				border: solid 1px white;
				border-radius: 4px;
				background-color: #6758ff;

				line-height: 32px;
				color: white;
				text-align: center;
			}

			.disable {
				background-color: gray !important;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="noteWrapper">
				<header class="flex">
					<div onclick="javascript:handleCloseButton()" class="closeButton"><img src="https://zep.us/images/svg/close__icon.svg" /></div>
				</header>
				<div id="buttonBox" class="flex box">
					<div class="flex onRight ">
						<div id="prevButton" class="button disable" onclick="javascript:handlePrevButton()">이전 장</div>
						<div id="nextButton" class="button disable" onclick="javascript:handleNextButton()">다음 장</div>
					</div>
				</div>
				<div class="dialogWrapper">
					<div id="dialog" class="dialog"></div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			let noteStatus =  {
				flowNo: 0,
				finishPage: -1,
				// startPage: 0,
				// endPage: -1,
			}
			let dialogFlow, currentPage, target;
			let condition = null;

			window.addEventListener("message", (e) => {
				condition =  e.data.condition;
				noteStatus = e.data.noteStatus;
				dialogFlow = NOTE_FLOW[noteStatus.flowNo];

				currentPage = 0;
				if(dialogFlow.pageList.length != 1){
					document.getElementById("nextButton").classList.remove('disable');
				}
				startDialog(dialogFlow, currentPage);

				// if (noteStatus.startPage > noteStatus.endPage) startDialog(dialogFlow, page);
				// else endDialog(dialogFlow);
			});

			const startDialog = (dialogFlow, page) => {
				document.getElementById("dialog").innerHTML = '';
				if (finishPage < currentPage) {
					setTimeout(async () => {
						const pageTextList = dialogFlow.pageList[page];
						for (var i = 0; i < pageTextList.length; i++) {
							document.getElementById("dialog").innerHTML += `<p id='text${i}'></p>`;
							const text = pageTextList[i];
							await typing(i, text);
							await wait(300);
						}
						finishPage = currentPage;
					}, 200);
				} else {
					endDialog(dialogFlow, page);
				}				
			}

			const typing = async (i, text) => {
				const target = document.getElementById(`text${i}`);
				const splitText = text.split('');

				while (splitText.length) {
					await wait(100);
					const c = splitText.shift();
					if (c == ' ') target.innerHTML += '&nbsp;'
					else target.innerText += c;
				}
			}

			const wait = (ms) => {
				return new Promise(res => setTimeout(res, ms));
			}

			const handleCloseButton = () => {
				window.parent.postMessage({type: "closeDialog"}, "*");
			}

			const handlePrevButton = () => {
				if (currentPage > 0) {
					currentPage = currentPage - 1;
					
					if (currentPage <= 0 && !document.getElementById("prevButton").classList.includes('disable')) {
						document.getElementById("prevButton").classList.add('disable');
					}
					if (currentPage < dialogFlow.pageList.length-1 && document.getElementById("nextButton").classList.includes('disable')) {
						document.getElementById("nextButton").classList.remove('disable');
					}

					startDialog(dialogFlow, currentPage);
				}
			}

			const handleNextButton = () => {
				if (currentPage < dialogFlow.pageList.length-1) {
					currentPage = currentPage + 1;
				
					if (currentPage > 0 && document.getElementById("prevButton").classList.includes('disable')) {
						document.getElementById("prevButton").classList.remove('disable');
					}
					if (currentPage >= dialogFlow.pageList.length-1 && !document.getElementById("nextButton").classList.includes('disable')) {
						document.getElementById("nextButton").classList.add('disable');
					}

					startDialog(dialogFlow, currentPage);
				}

				if (currentPage == dialogFlow.pageList.length-1) {
					noteStatus.isFinish = isFinish;
					saveNoteStatus();
				}
			}

			const endDialog = (dialogFlow, page) => {
				for (text of dialogFlow.pageList[page]) {
					document.getElementById("dialog").innerHTML += `
						<p id='text${i}'>
							${text}
						</p>`;
				}
			}

			const saveNoteStatus = () => {
				console.log('save noteStatus : ', noteStatus);
				window.parent.postMessage({type: "saveHansNote", noteStatus }, "*");
			}

			// const removeDialog = () => {
			// 	document.getElementById("dialog").innerHTML = '';
			// }


			// const handleSelectOption = (optNo, link, listNo = -1) => {
			// 	if(selectedOptionNo != -1){
			// 		document.getElementById(`option${selectedOptionNo}`).classList.remove("selected");
			// 	}
				
			// 	selectedOptionNo = optNo;
			// 	selectedLink = link;
			// 	selectedCheckListNo = listNo;
			// 	document.getElementById(`option${optNo}`).classList.add("selected");
			// 	document.getElementById("button").classList.remove("disable");
			// }

			// const handleButton = () => {
			// 	if (selectedLink == -1){
			// 		handleCloseButton();
			// 	} else if(selectedLink == -3) {
			// 		window.parent.postMessage({type: "setCheckList", listNo: selectedCheckListNo}, "*");
			// 		handleCloseButton();
			// 	} else {
			// 		removeDialog();
					
			// 		if (dialogFlow[selectedLink].options) {
			// 			setOptions(selectedLink);
			// 		} else {
			// 			document.getElementById("optionBox").classList.add('none');
			// 		}
			// 	}
				
			// 	selectedOptionNo = -1;
			// 	selectedLink = -11;
			// 	selectedCheckListNo = -1;
			// 	document.getElementById("button").classList.add("disable");
			// }

			const NOTE_FLOW = [
				{
					link: -3,
					listNo: 6,
					pageList: [
						[
							"안녕하세요!",
							"혹시... 글자가 보이시나요?!",
							"많이 놀라셨죠..! 한스입니다!!",
							"이 책을 열어보시는 분이 계시다니...",
							"정말 다행입니다!!"
						],
						[
							"믿기 힘드시겠지만...",
							"저는 지금 거울 세계에 있습니다!",
							"이 책을 통해 현실 세계로 메세지를 전달할 수는 있는데,",
							"현실 세계에서 거울 세계로는 아직 방법이 없습니다...",
							"하지만, 현실이 바뀌면 거울 세계에 바로 반영이 돼서 알 수 있어요!"
						],
						[
							"그런데, 거울 세계가 현실의 2년 정도 미래에요!",
							"제가 미래에서 현실로 메세지를 보내고 있는 것이죠!",
							"미래에 있어서 참 좋을 것 같지만...",
							"이 곳의 상황이 상당히 충격적이라...",
							"이 미래를 바꿔주세요!몇 가지 부탁이 있어요!"
						],
						[
							"그래서 제가 생각한 방안 몇 가지가 있는데,",
							"첫 번째는 지금 현실세계에",
							"혼자 폭포수로 뛰어들려는 분이 계시는데요...",
							"이분을 막아주세요...!",
							"기다리고 있을게요!"
						]
					]
				}
			];
		</script>
	</body>
</html>
